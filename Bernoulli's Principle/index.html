
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>Venturi Tube • Bernoulli's Principle (Glottis)</title>
<style>
  :root {
    --bg:#0f1115; --panel:#121722; --tube:#1e2a3b; --tubeEdge:#2b3b55;
    --text:#e8eefc; --muted:#a8b3c7; --accent:#5ab0ff; --good:#4ade80; --warn:#f59e0b; --particle:#ffff00;
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%; width:100%; overflow-x:hidden}
  body {
    margin:0; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    padding:12px;
  }
  .app {
    max-width:100vw;
    margin:0 auto;
    display:grid; gap:10px;
    background:var(--panel); border:1px solid #243046; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.25);
  }
  header {
    padding:10px 12px; border-bottom:1px solid #1f2a3f;
    display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between;
  }
  header h1 {
    margin:0; line-height:1.25; font-weight:600; letter-spacing:.2px;
    font-size:clamp(14px, 4vw, 18px);
    flex:1 1 260px;
  }
  #controls{display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; flex:1 1 240px}
  label{font-size:14px; color:var(--muted); white-space:nowrap}
  #speedLabel{color:var(--text)}
  input[type=range]{width:min(220px, 60vw)}
  .btn {
    background:#182036; color:var(--text); border:1px solid #2a3a58; border-radius:10px; padding:10px 14px; font-size:14px; cursor:pointer;
  }
  .canvas-wrap{width:100%}
  #sim {
    display:block;
    width:100%;
    max-width:100vw;
    height:auto;
    aspect-ratio: 1100 / 380;
    background:linear-gradient(#0c1220,#0a0f1a);
  }
  .statbar {
    display:grid; grid-template-columns: repeat(4, minmax(0,1fr));
    gap:8px; padding:10px 12px; border-top:1px solid #1f2a3f; background:#0f1523;
  }
  .stat{background:#10182a; border:1px solid #1f2a3f; border-radius:12px; padding:10px}
  .stat .hd{font-size:12px; color:var(--muted); margin-bottom:4px}
  .stat .val{font-size:16px; font-weight:600}
  .stat.good .val{color:var(--good)} .stat.warn .val{color:var(--warn)}
  footer{font-size:12px; color:var(--muted); text-align:center; padding:8px 12px 12px}
</style>
</head>
<body>
<div class="app">
<header>
<h1>Venturi Tube — Bernoulli’s Principle (Particles speed up at the glottis)</h1>
<div id="controls">
<label for="speed">Time scale: <strong id="speedLabel">1×</strong></label>
<input id="speed" max="100" min="1" step="1" type="range" value="1"/>
<button aria-controls="sim" aria-pressed="false" class="btn" id="toggle">Pause</button>
<button class="btn" id="reset">Reset</button>
</div>
</header>
<div class="canvas-wrap">
<canvas aria-label="Venturi tube simulation with flowing particles" height="380" id="sim" width="1100"></canvas>
</div>
<div class="statbar">
<div class="stat"><div class="hd">ρ (air density)</div><div class="val"><span id="rho">1.20</span> kg/m³</div></div>
<div class="stat"><div class="hd">Wide-section velocity</div><div class="val"><span id="vWide">—</span> m/s</div></div>
<div class="stat warn"><div class="hd">Glottis (narrow) velocity</div><div class="val"><span id="vNarrow">—</span> m/s</div></div>
<div class="stat good"><div class="hd">Static pressure drop (wide → glottis)</div><div class="val"><span id="dP">—</span> kPa</div></div>
</div>
<footer>
      Pressures from Bernoulli (level flow): P + ½ρv² = constant. Wide static pressure set near 101.3 kPa; values shown update continuously.
    </footer>
</div>
<script>
(() => {
  const canvas = document.getElementById('sim');
  const ctx = canvas.getContext('2d');

  const speedSlider = document.getElementById('speed');
  const speedLabel  = document.getElementById('speedLabel');
  const btnToggle   = document.getElementById('toggle');
  const btnReset    = document.getElementById('reset');
  const vWideEl     = document.getElementById('vWide');
  const vNarEl      = document.getElementById('vNarrow');
  const dPEl        = document.getElementById('dP');
  const rhoEl       = document.getElementById('rho');

  const rho = 1.20; rhoEl.textContent = rho.toFixed(2);
  const P_ambient = 101.3e3;
  const tubeLogicalW = 1100, tubeLogicalH = 380;
  let tubeLen = tubeLogicalW, tubeMid = tubeLogicalH/2;

  const H_wide=90, H_throat=20, throatX=tubeLogicalW*0.50, throatWidthFrac=0.04, sigma=tubeLogicalW*throatWidthFrac*0.35;
  function halfHeight(x) {
  const dx = x - throatX;
  const dip = (H_wide - H_throat) * Math.exp(-(dx * dx) / (2 * sigma * sigma));
  const rise = (H_throat - 30) * Math.exp(-(dx * dx) / (2 * (sigma * 1.8) ** 2));
  return H_wide - dip + rise;
}

  const vWideTarget=1.2, xWideRef=tubeLogicalW*0.05, A_wide=halfHeight(xWideRef), Q=vWideTarget*A_wide;
  function velocityAtX(x){ return Q / Math.max(halfHeight(x),1); }

  const v_wide_ref=velocityAtX(xWideRef), P_total=P_ambient+0.5*rho*v_wide_ref*v_wide_ref;
  const pressureAtV = v => P_total - 0.5*rho*v*v;

  const particles=[]; const particleColor=getComputedStyle(document.documentElement).getPropertyValue('--particle').trim()||'#ffff00';
  function spawnParticle(){
    const x = -Math.random()*40 - 10;
    const y = tubeMid + (Math.random()*2-1)*(halfHeight(0)-6);
    particles.push({x,y,age:0});
  }
  let spawnAccumulator=0;

  function drawTube(){
    ctx.save();
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(0, tubeMid - halfHeight(0));
    for(let x=0; x<=tubeLen; x+=4) ctx.lineTo(x, tubeMid - halfHeight(x));
    for(let x=tubeLen; x>=0; x-=4) ctx.lineTo(x, tubeMid + halfHeight(x));
    ctx.closePath();
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--tube'); ctx.fill();
    ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--tubeEdge'); ctx.stroke();

    ctx.setLineDash([6,6]); ctx.strokeStyle='rgba(255,255,255,0.12)';
    ctx.beginPath(); ctx.moveTo(0, tubeMid); ctx.lineTo(tubeLen, tubeMid); ctx.stroke();
    ctx.restore();
  }

  const inTube=(x,y)=>{const h=halfHeight(x); return y>tubeMid-h+2 && y<tubeMid+h-2;}
  function verticalDrift(x, y) {
  const h = halfHeight(x);
  const dist = y - tubeMid;
  const pull = (x < throatX - 30) ? -1.1 : (x > throatX + 30) ? 1.05 : 0;


  // Add vibration after the throat
  const vibration = (x > throatX + 50) ? Math.sin(x * 0.15 + performance.now() * 0.045) * 0.6 : 0;

  return pull * (0.5 / h) * dist + vibration;
}

  let timeScale=1, running=true;
  speedSlider.addEventListener('input', ()=>{timeScale=+speedSlider.value; speedLabel.textContent=`${timeScale}×`});
  btnToggle.addEventListener('click', ()=>{
    running=!running; btnToggle.textContent=running?'Pause':'Play'; btnToggle.setAttribute('aria-pressed', String(!running));
    if(running) lastT=performance.now(); requestAnimationFrame(loop);
  });
  btnReset.addEventListener('click', ()=>{particles.length=0});

  function updateStats(){
    const vWide=velocityAtX(xWideRef), vThroat=velocityAtX(throatX);
    const dP=(pressureAtV(vWide)-pressureAtV(vThroat))/1000;
    vWideEl.textContent=vWide.toFixed(2); vNarEl.textContent=vThroat.toFixed(2); dPEl.textContent=dP.toFixed(2);
  }

  let lastT=performance.now();
  function loop(now){
    if(!running) return;
    const dt = Math.min((now-lastT)/1000, .05) * timeScale; lastT=now;

    updateStats();
    ctx.setTransform(scaleX,0,0,scaleY,0,0);
    ctx.clearRect(0,0,tubeLogicalW,tubeLogicalH);

    drawTube();

    const inletSpeed=velocityAtX(0);
    spawnAccumulator += 180*Math.sqrt(inletSpeed)*dt;
    while(spawnAccumulator>=1){ spawnParticle(); spawnAccumulator-=1; }

    ctx.fillStyle=particleColor;
    const metersToPixels=100, size=4;
    for(let i=particles.length-1;i>=0;i--){
      const p=particles[i];
      p.x += velocityAtX(p.x)*metersToPixels*dt;
      p.y += verticalDrift(p.x,p.y)*metersToPixels*dt;
      p.age += dt;
      if(p.x>tubeLogicalW+10 || !inTube(p.x,p.y) || p.age>20){ particles.splice(i,1); continue; }
      ctx.fillRect(p.x|0, p.y|0, size, size);
    }

    // glottis marker
    ctx.save();
    ctx.strokeStyle='rgba(255,255,255,0.25)'; ctx.setLineDash([4,6]);
    ctx.beginPath(); ctx.moveTo(throatX, tubeMid - halfHeight(throatX) - 16); ctx.lineTo(throatX, tubeMid + halfHeight(throatX) + 16); ctx.stroke();
    ctx.setLineDash([]); ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.font='12px system-ui, sans-serif'; ctx.textAlign='center';
    ctx.fillText('Glottis', throatX, tubeMid - halfHeight(throatX) - 20);
    ctx.restore();

    requestAnimationFrame(loop);
  }

  let scaleX=1, scaleY=1;
  function resize(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const cssW = Math.max(1, canvas.clientWidth);
    const cssH = Math.max(1, canvas.clientHeight);

    canvas.width  = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);

    scaleX = (canvas.width  / tubeLogicalW);
    scaleY = (canvas.height / tubeLogicalH);
    ctx.setTransform(scaleX,0,0,scaleY,0,0);

    tubeLen = tubeLogicalW;
    tubeMid = tubeLogicalH/2;
  }
  resize();
  new ResizeObserver(resize).observe(canvas);

  updateStats();
  requestAnimationFrame((t)=>{ lastT=t; loop(t); });
})();
</script>
</body>
</html>
